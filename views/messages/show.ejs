<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title><%= title %></title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-100 min-h-screen flex flex-col">
    <%- include("../partials/navbar") %>
    <%- include("../partials/alerts") %>

    <main class="flex-1 container mx-auto px-4 py-8">
      <section class="max-w-3xl mx-auto space-y-8">
        <!-- Post details -->
        <article class="bg-white rounded-lg shadow-sm border p-4">
          <h1 class="text-2xl font-bold mb-2"><%= message.title %></h1>

          <p class="text-slate-800 whitespace-pre-line mb-4"><%= message.body %></p>

          <div class="text-sm text-slate-600 mb-2">
            By <span class="font-medium"><%= message.first_name %> <%= message.last_name %></span>
            • <%= new Date(message.created_at).toLocaleString() %>
          </div>

          <% if (isAdmin) { %>
            <form
              action="/messages/<%= message.id %>?_method=DELETE"
              method="POST"
              class="mt-2"
              onsubmit="return confirm('Delete this message?');"
            >
              <button
                type="submit"
                class="text-xs px-3 py-1 rounded-full bg-red-600 text-white"
              >
                Delete post
              </button>
            </form>
          <% } %>
        </article>

        <!-- Edit form (only author or admin) -->
        <% if (currentUser && (currentUser.id === message.user_id || isAdmin)) { %>
          <section class="bg-white rounded-lg shadow-sm border p-4">
            <h2 class="text-lg font-semibold mb-3">Edit your post</h2>

            <form
              action="/messages/<%= message.id %>?_method=PUT"
              method="POST"
              class="space-y-4"
            >
              <div>
                <label class="block text-sm font-medium mb-1" for="title">Title</label>
                <input
                  type="text"
                  id="title"
                  name="title"
                  value="<%= editFormData.title %>"
                  class="w-full border rounded px-3 py-2"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1" for="body">Message</label>
                <textarea
                  id="body"
                  name="body"
                  rows="4"
                  class="w-full border rounded px-3 py-2"
                  required
                ><%= editFormData.body %></textarea>
              </div>

              <% if (errors && errors.length) { %>
                <div class="bg-red-100 text-red-800 text-sm px-3 py-2 rounded">
                  <ul class="list-disc list-inside">
                    <% errors.forEach(err => { %>
                      <li><%= err.msg %></li>
                    <% }) %>
                  </ul>
                </div>
              <% } %>

              <button
                type="submit"
                class="px-4 py-2 rounded-full bg-black text-white text-sm font-semibold"
              >
                Save changes
              </button>
            </form>
          </section>
        <% } %>

        <!-- Comments section -->
        <section class="bg-white rounded-lg shadow-sm border p-4">
          <h2 class="text-lg font-semibold mb-3">Comments</h2>

          <% if (!comments || comments.length === 0) { %>
            <p class="text-slate-600 text-sm mb-4">No comments yet.</p>
          <% } else { %>
            <ul class="space-y-3 mb-4">
              <% comments.forEach(c => { %>
                <li class="border-b pb-2">
                  <p class="text-slate-800 whitespace-pre-line"><%= c.body %></p>
                  <div class="text-xs text-slate-600 mt-1 flex items-center justify-between">
                    <span>
                      By <span class="font-medium"><%= c.first_name %> <%= c.last_name %></span>
                      • <%= new Date(c.created_at).toLocaleString() %>
                    </span>
                    <% if (isAdmin) { %>
                      <form
                        action="/comments/<%= c.id %>?_method=DELETE&messageId=<%= message.id %>"
                        method="POST"
                        onsubmit="return confirm('Delete this comment?');"
                      >
                        <button type="submit" class="text-red-600 text-xs">Delete</button>
                      </form>
                    <% } %>
                  </div>
                </li>
              <% }) %>
            </ul>
          <% } %>

          <!-- New comment form -->
          <form
            action="/messages/<%= message.id %>/comments"
            method="POST"
            class="space-y-3"
          >
            <div>
              <label class="block text-sm font-medium mb-1" for="commentBody">Add a comment</label>
              <textarea
                id="commentBody"
                name="commentBody"
                rows="3"
                class="w-full border rounded px-3 py-2"
                required
              ></textarea>
            </div>

            <button
              type="submit"
              class="px-4 py-2 rounded-full bg-black text-white text-sm font-semibold"
            >
              Post comment
            </button>
          </form>
        </section>

        <div>
          <a href="/" class="text-sm underline text-slate-700">&larr; Back to all messages</a>
        </div>
      </section>
    </main>
  </body>
</html>